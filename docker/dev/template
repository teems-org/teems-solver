FROM ubuntu:22.04

# Set environment variables in one layer
ENV DEBIAN_FRONTEND=noninteractive \
    PATH="$PATH:/usr/local/go/bin" \
    SINGULARITY_VERSION=4.0.0 \
    GO_VERSION=1.21.6

# Configure APT and install packages in a single layer
RUN echo 'APT::Install-Suggests "0";' >> /etc/apt/apt.conf.d/00-docker \
    && echo 'APT::Install-Recommends "0";' >> /etc/apt/apt.conf.d/00-docker \
    && apt-get update \
    && apt-get install -y \
        autoconf \
        automake \
        build-essential \
        uuid-dev \
        libgpgme-dev \
        squashfs-tools \
        libseccomp-dev \
        pkg-config \
        libglib2.0-dev \
        libfuse3-dev \
        libtool \
        cryptsetup-bin \
        wget \
        libxml2 \
        libglpk-dev \
        acl \
        python3 \
        python3-pip \
        tzdata \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Go
RUN cd /tmp \
    && wget https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz \
    && tar -C /usr/local -xzf go${GO_VERSION}.linux-amd64.tar.gz \
    && rm go${GO_VERSION}.linux-amd64.tar.gz

# Install Singularity
RUN wget https://github.com/sylabs/singularity/releases/download/v${SINGULARITY_VERSION}/singularity-ce-${SINGULARITY_VERSION}.tar.gz \
    && tar -xzf singularity-ce-${SINGULARITY_VERSION}.tar.gz -C /opt \
    && rm singularity-ce-${SINGULARITY_VERSION}.tar.gz \
    && cd /opt/singularity-ce-${SINGULARITY_VERSION} \
    && ./mconfig \
    && make -C ./builddir \
    && make -C ./builddir install \
    && cd / && rm -rf /opt/singularity-ce-${SINGULARITY_VERSION}

# Install Python libraries
RUN pip3 install --no-cache-dir pandas toolz numpy Pyarrow

# Uncomment these when ready to use
# RUN mkdir -p /home/launchpad
# COPY launchpad/solver.sif /home
# COPY sol_parser/ /home/sol_parser
# WORKDIR /home/launchpad

CMD ["/init"]